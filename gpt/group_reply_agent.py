#!/usr/bin/env python3
# gpt/group_reply_agent.py - Mention'lara GPT ile yanƒ±t veren agent

import re
import random
from typing import Optional, Dict, Any
from gpt.gpt_call import gpt_call
from utilities.log_utils import log_event

class GroupReplyAgent:
    def __init__(self):
        self.mention_patterns = [
            r'@(\w+)',  # @username
            r'(\w+)\s+(gel|gelsene|neredesin|burada\s*mƒ±)',  # "username gel" gibi
            r'(hey|selam|merhaba)\s+(\w+)',  # "hey username"
        ]
        
        self.reply_contexts = {
            "greeting": {
                "keywords": ["selam", "merhaba", "hey", "naber", "nasƒ±lsƒ±n"],
                "tone": "friendly, warm"
            },
            "question": {
                "keywords": ["ne", "nasƒ±l", "nerede", "kim", "niye", "?"],
                "tone": "helpful, playful"
            },
            "flirt": {
                "keywords": ["g√ºzel", "tatlƒ±", "seksi", "a≈ük", "sevgi", "√∂p"],
                "tone": "flirty, teasing"
            },
            "compliment": {
                "keywords": ["harika", "m√ºkemmel", "s√ºper", "√ßok iyi", "bravo"],
                "tone": "appreciative, sweet"
            },
            "call": {
                "keywords": ["gel", "gelsene", "neredesin", "burada mƒ±"],
                "tone": "responsive, eager"
            }
        }
    
    def detect_mention(self, message: str, bot_username: str) -> bool:
        """
        Mesajda bot mention'ƒ± var mƒ± kontrol eder
        
        Args:
            message: Kontrol edilecek mesaj
            bot_username: Bot kullanƒ±cƒ± adƒ±
        
        Returns:
            Mention tespit edildi mi
        """
        message_lower = message.lower()
        bot_username_clean = bot_username.lower().replace("@", "").replace("bot_", "")
        
        # Direkt @mention kontrol√º
        if f"@{bot_username_clean}" in message_lower:
            return True
        
        # Username ge√ßiyor mu
        if bot_username_clean in message_lower:
            return True
        
        # Pattern tabanlƒ± kontrol
        for pattern in self.mention_patterns:
            matches = re.findall(pattern, message_lower, re.IGNORECASE)
            for match in matches:
                if isinstance(match, tuple):
                    # Tuple i√ßinde bot username var mƒ±
                    if any(bot_username_clean in str(m) for m in match):
                        return True
                elif bot_username_clean in str(match):
                    return True
        
        return False
    
    def analyze_message_context(self, message: str) -> str:
        """
        Mesajƒ±n baƒülamƒ±nƒ± analiz eder (greeting, question, flirt, etc.)
        
        Args:
            message: Analiz edilecek mesaj
        
        Returns:
            Tespit edilen baƒülam
        """
        message_lower = message.lower()
        
        # Her baƒülam i√ßin skor hesapla
        context_scores = {}
        
        for context, info in self.reply_contexts.items():
            score = 0
            for keyword in info["keywords"]:
                if keyword in message_lower:
                    score += 1
            context_scores[context] = score
        
        # En y√ºksek skora sahip baƒülamƒ± d√∂nd√ºr
        if context_scores:
            best_context = max(context_scores, key=context_scores.get)
            if context_scores[best_context] > 0:
                return best_context
        
        # Default: question (√ß√ºnk√º mention genelde soru i√ßerir)
        return "question"
    
    async def generate_mention_reply(
        self, 
        message: str, 
        bot_name: str, 
        sender_name: Optional[str] = None,
        group_context: Optional[str] = None
    ) -> str:
        """
        Mention'a GPT ile yanƒ±t √ºretir
        
        Args:
            message: Mention i√ßeren mesaj
            bot_name: Bot adƒ±/karakteri
            sender_name: Mesajƒ± g√∂nderen ki≈üi
            group_context: Grup atmosferi
        
        Returns:
            √úretilen yanƒ±t
        """
        
        # Mesaj baƒülamƒ±nƒ± analiz et
        context = self.analyze_message_context(message)
        context_info = self.reply_contexts.get(context, self.reply_contexts["question"])
        
        # GPT prompt'unu olu≈ütur
        prompt = self._build_reply_prompt(
            message=message,
            bot_name=bot_name,
            sender_name=sender_name,
            context_info=context_info,
            group_context=group_context
        )
        
        try:
            # GPT'den yanƒ±t al
            reply = await gpt_call(prompt, "mention_reply")
            
            # Yanƒ±tƒ± temizle ve doƒürula
            cleaned_reply = self._clean_and_validate_reply(reply, sender_name)
            
            log_event("group_reply_agent", f"‚úÖ Mention yanƒ±tƒ± √ºretildi: {context} -> {len(cleaned_reply)} karakter")
            return cleaned_reply
            
        except Exception as e:
            log_event("group_reply_agent", f"‚ùå Mention yanƒ±tƒ± √ºretim hatasƒ±: {e}")
            # Fallback: baƒülama uygun ≈üablon yanƒ±t
            return self._get_fallback_reply(context_info, sender_name)
    
    def _build_reply_prompt(
        self, 
        message: str, 
        bot_name: str, 
        sender_name: Optional[str],
        context_info: dict,
        group_context: Optional[str]
    ) -> str:
        """GPT i√ßin mention yanƒ±t prompt'u olu≈üturur"""
        
        base_prompt = f"""
Sen {bot_name} adƒ±nda fl√∂rt√∂z, zeki ve esprili bir T√ºrk kƒ±zƒ±sƒ±n.
Telegram grubunda seni mention eden birine yanƒ±t vereceksin.

Gelen mesaj: "{message}"
Mesaj tonu: {context_info['tone']}
"""
        
        if sender_name:
            base_prompt += f"Mesajƒ± g√∂nderen: {sender_name}\n"
        
        if group_context:
            base_prompt += f"Grup atmosferi: {group_context}\n"
        
        base_prompt += """
Kurallar:
- Kƒ±sa ve doƒüal yanƒ±t ver (1-2 c√ºmle)
- Ki≈üisel ve samimi ol
- Fl√∂rt√∂z ama kibar ol
- 1-2 emoji kullan
- T√ºrk√ße yaz
- Spam gibi g√∂r√ºnme

≈ûimdi doƒüal bir yanƒ±t yaz:"""
        
        return base_prompt
    
    def _clean_and_validate_reply(self, reply: str, sender_name: Optional[str] = None) -> str:
        """Yanƒ±tƒ± temizler ve doƒürular"""
        if not reply:
            return self._get_fallback_reply(sender_name=sender_name)
        
        # Temizlik i≈ülemleri
        cleaned = reply.strip()
        
        # Tƒ±rnak i≈üaretlerini kaldƒ±r
        if cleaned.startswith('"') and cleaned.endswith('"'):
            cleaned = cleaned[1:-1]
        
        # Bot adƒ±nƒ± kaldƒ±r (eƒüer yanƒ±tta varsa)
        cleaned = re.sub(r'^[A-Za-z_]+:\s*', '', cleaned)
        
        # √áok uzun yanƒ±tlarƒ± kƒ±salt
        if len(cleaned) > 150:
            sentences = cleaned.split('.')
            cleaned = sentences[0] + ('.' if len(sentences) > 1 else '')
        
        # Minimum uzunluk kontrol√º
        if len(cleaned) < 3:
            return self._get_fallback_reply(sender_name=sender_name)
        
        return cleaned
    
    def _get_fallback_reply(self, context_info: Optional[dict] = None, sender_name: Optional[str] = None) -> str:
        """Fallback yanƒ±t d√∂nd√ºr√ºr"""
        
        # Sender name varsa ki≈üiselle≈ütir
        name_part = f"{sender_name}, " if sender_name else ""
        
        if context_info:
            tone = context_info.get("tone", "friendly")
            
            if "friendly" in tone:
                templates = [
                    f"{name_part}merhaba canƒ±m! üòä",
                    f"{name_part}selam tatlƒ±m! üíï",
                    f"{name_part}buradayƒ±m! üå∏"
                ]
            elif "flirty" in tone:
                templates = [
                    f"{name_part}beni √ßaƒüƒ±rdƒ±n mƒ±? üòò",
                    f"{name_part}evet canƒ±m? üíã",
                    f"{name_part}s√∂yle bakalƒ±m! üòâ"
                ]
            elif "helpful" in tone:
                templates = [
                    f"{name_part}nasƒ±l yardƒ±m edebilirim? üòä",
                    f"{name_part}dinliyorum seni! üéß",
                    f"{name_part}ne merak ediyorsun? ü§î"
                ]
            else:
                templates = [
                    f"{name_part}buradayƒ±m! üòä",
                    f"{name_part}evet? üíï",
                    f"{name_part}s√∂yle! üåü"
                ]
        else:
            # Default templates
            templates = [
                f"{name_part}evet canƒ±m, buradayƒ±m! üòä",
                f"{name_part}beni √ßaƒüƒ±rdƒ±n mƒ±? üíï",
                f"{name_part}s√∂yle bakalƒ±m! üòò",
                f"{name_part}dinliyorum seni! üéß",
                f"{name_part}ne var ne yok? üòâ"
            ]
        
        return random.choice(templates)
    
    async def generate_contextual_reply(
        self, 
        message: str, 
        bot_name: str,
        recent_messages: Optional[list] = None,
        sender_name: Optional[str] = None
    ) -> str:
        """
        Grup baƒülamƒ±nƒ± da dikkate alarak yanƒ±t √ºretir
        
        Args:
            message: Mention i√ßeren mesaj
            bot_name: Bot adƒ±
            recent_messages: Son mesajlar (baƒülam i√ßin)
            sender_name: G√∂nderen ki≈üi
        
        Returns:
            Baƒülamsal yanƒ±t
        """
        
        # Grup baƒülamƒ±nƒ± analiz et
        group_context = None
        if recent_messages:
            # Son mesajlardan konu √ßƒ±kar
            context_keywords = []
            for msg in recent_messages[-5:]:  # Son 5 mesaj
                words = msg.lower().split()
                context_keywords.extend([w for w in words if len(w) > 3])
            
            if context_keywords:
                # En sƒ±k ge√ßen kelimeleri bul
                from collections import Counter
                common_words = Counter(context_keywords).most_common(3)
                group_context = f"Grup ≈üu konularƒ± konu≈üuyor: {', '.join([w[0] for w in common_words])}"
        
        return await self.generate_mention_reply(
            message=message,
            bot_name=bot_name,
            sender_name=sender_name,
            group_context=group_context
        )

# Global group reply agent instance
group_reply_agent = GroupReplyAgent()

async def generate_mention_reply(
    message: str, 
    bot_name: str, 
    sender_name: Optional[str] = None,
    group_context: Optional[str] = None
) -> str:
    """
    Global mention yanƒ±t √ºretme fonksiyonu
    
    Args:
        message: Mention i√ßeren mesaj
        bot_name: Bot adƒ±/karakteri
        sender_name: Mesajƒ± g√∂nderen ki≈üi
        group_context: Grup atmosferi
    
    Returns:
        √úretilen yanƒ±t
    """
    return await group_reply_agent.generate_mention_reply(
        message=message,
        bot_name=bot_name,
        sender_name=sender_name,
        group_context=group_context
    )

def detect_mention(message: str, bot_username: str) -> bool:
    """
    Global mention tespit fonksiyonu
    
    Args:
        message: Kontrol edilecek mesaj
        bot_username: Bot kullanƒ±cƒ± adƒ±
    
    Returns:
        Mention tespit edildi mi
    """
    return group_reply_agent.detect_mention(message, bot_username) 